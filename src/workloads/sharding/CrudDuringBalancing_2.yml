SchemaVersion: 2018-07-01
Owner: "@mongodb/sharding"
Description: |
  TODO
GlobalDefaults:
  Nop: &Nop {Nop: true}

  Database: &Database test
  # Collection0 is the default collection populated by the MonotonicSingleLoader.
  Collection: &Collection Collection0
  Namespace: &Namespace test.Collection0

  ApproxDocumentSize: &ApproxDocumentSize 1000  # = 1kB
  ApproxDocumentSize80Pct: &ApproxDocumentSize80Pct 800  # = 0.8kB
  DocumentCount: &DocumentCount 10000000 # for an approximate total of 10GB
  NumChunkSplits: &NumChunkSplits 4000

  ShardKeyValueMin: &ShardKeyValueMin 1
  ShardKeyValueMax: &ShardKeyValueMax 10000000

  ReadRate: &ReadRate 1 per 500 microseconds # 2000/sec

  ReadWriteOperations: &ReadWriteOperations
  - OperationName: findOne
    OperationCommand:
      Filter: {skey: *ShardKeyValueMax}
      Options:
        ReadPreference:
          ReadMode: primary

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 300

Actors:
- Name: DropDatabase # (1)
  Type: RunCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: *Database
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - Nop: true # (2)
  - Nop: true # (3)
  - Nop: true # (4)
  - Nop: true # (5)
  - Nop: true # (6)

- Name: LoadInitialData
  Type: Loader
  Threads: 100
  Phases:
  - Nop: true # (1)
  - Repeat: 1 # (2)
    BatchSize: 1000
    MultipleThreadsPerCollection: true
    CollectionCount: 1
    DocumentCount: *DocumentCount
    Database: *Database
    Document:
      skey: {^RandomInt: {min: *ShardKeyValueMin, max: *ShardKeyValueMax}}
      padding: {^FastRandomString: {length: {^RandomInt: {min: *ApproxDocumentSize80Pct, max: *ApproxDocumentSize}}}}
  - Nop: true # (3)
  - Nop: true # (4)
  - Nop: true # (5)
  - Nop: true # (6)

- Name: CreateIndex
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true # (1)
  - Nop: true # (2)
  - Repeat: 1 # (3)
    Database: *Database
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: Collection0
        indexes:
        - key:
            skey: 1
          name: skey
  - Nop: true # (4)
  - Nop: true # (5)
  - Nop: true # (6)

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - Nop: true # (1)
  - Nop: true # (2)
  - Nop: true # (3)
  - Repeat: 1 # (4)
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand:
        balancerStop: true
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *Database
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: *Namespace
        key: {skey: 1}
  - Nop: true # (5)
  - Nop: true # (6)

- Name: SplitChunks
  Type: AdminCommand
  Threads: 1
  Phases:
    - Nop: true # (1)
    - Nop: true # (2)
    - Nop: true # (3)
    - Nop: true # (4)
    - Repeat: *NumChunkSplits # (5)
      Database: admin
      Operations:
      - OperationMetricsName: SplitChunks
        OperationName: AdminCommand
        OperationCommand:
          split: *Namespace
          middle: {skey: {^RandomInt: {min: *ShardKeyValueMin, max: *ShardKeyValueMax}}}
    - Nop: true # (6)

- Name: MoveChunks
  Type: MoveRandomChunkToRandomShard
  Threads: 1
  Phases:
  - Nop: true # (1)
  - Nop: true # (2)
  - Nop: true # (3)
  - Nop: true # (4)
  - Nop: true # (5)
  - Duration: 10 minutes # (6)
    Namespace: *Namespace

- Name: ReadCollectionWhileBalancing
  Type: CrudActor
  GlobalRate: *ReadRate
  Database: *Database
  Phases:
  - Nop: true # (1)
  - Nop: true # (2)
  - Nop: true # (3)
  - Nop: true # (4)
  - Nop: true # (5)
  - MetricsName: DuringBalancing # (6)
    Duration: 10 minutes
    Collection: *Collection
    Operations: *ReadWriteOperations

AutoRun:
- When:
    mongodb_setup:
      $eq: shard-lite
